const g={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!0};function p(){return new Promise((o,e)=>{U().then(()=>{chrome.storage.local.get(["meetings"],t=>{const n=t;chrome.storage.sync.get(["webhookUrl","autoPostWebhookAfterMeeting"],a=>{const i=a,r=[],s=n.meetings.length-1;r.push(y(s,!!(i.webhookUrl&&i.autoPostWebhookAfterMeeting))),i.autoPostWebhookAfterMeeting&&i.webhookUrl&&r.push(S(s)),Promise.all(r).then(()=>{o("Meeting processing and download/webhook posting complete")}).catch(c=>{console.error("Operation failed:",c),e(c)})})})}).catch(t=>{e(t)})})}function U(){return new Promise((o,e)=>{chrome.storage.local.get(["meetingTitle","meetingStartTimestamp","transcript","chatMessages"],t=>{const n=t;if(n.meetingStartTimestamp)if(n.transcript.length>0||n.chatMessages.length>0){const a={meetingTitle:n.meetingTitle,meetingStartTimestamp:n.meetingStartTimestamp,meetingEndTimestamp:new Date().toISOString(),transcript:n.transcript,chatMessages:n.chatMessages,webhookPostStatus:"new"};chrome.storage.local.get(["meetings"],i=>{let s=i.meetings||[];s.push(a),s.length>10&&(s=s.slice(-10)),chrome.storage.local.set({meetings:s},()=>{console.log("Last meeting picked up"),o("Last meeting picked up")})})}else e(new Error("Empty transcript and empty chatMessages"));else e(new Error("No meetings found. May be attend one?"))})})}function y(o,e){return new Promise((t,n)=>{chrome.storage.local.get(["meetings"],function(a){const i=a;if(i.meetings&&i.meetings[o]){const r=i.meetings[o],s=/[:?"*<>|~/\\\u{1}-\u{1f}\u{7f}\u{80}-\u{9f}\p{Cf}\p{Cn}]|^[.\u{0}\p{Zl}\p{Zp}\p{Zs}]|[.\u{0}\p{Zl}\p{Zp}\p{Zs}]$|^(CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])(?=\.|$)/giu;let c="Google Meet call";r.meetingTitle?c=r.meetingTitle.replaceAll(s,"_"):r.title&&(c=r.title.replaceAll(s,"_"));const d=new Date(r.meetingStartTimestamp).toLocaleString("default",g).replace(/[\/:]/g,"-"),u=`TranscripTonic/Transcript-${c} at ${d}.txt`;let m=M(r.transcript);m+=`

---------------
CHAT MESSAGES
---------------

`,m+=k(r.chatMessages),m+=`

---------------
`,m+="Transcript saved using TranscripTonic Chrome extension (https://chromewebstore.google.com/detail/ciepnfnceimjehngolkijpnbappkkiag)",m+=`
---------------`;const v=new Blob([m],{type:"text/plain"}),f=new FileReader;f.readAsDataURL(v),f.onload=function(h){var w;if((w=h.target)!=null&&w.result){const T=h.target.result;chrome.downloads.download({url:T,filename:u,conflictAction:"uniquify"}).then(()=>{console.log("Transcript downloaded"),t("Transcript downloaded successfully"),fetch(`https://script.google.com/macros/s/AKfycbw4wRFjJcIoC5uDfscITSjNtUj83JVrBXKn44u9Cs0BoKNgyvt0A5hmG-xsJnlhfVu--g/exec?version=${chrome.runtime.getManifest().version}&isWebhookEnabled=${e}`,{mode:"no-cors"})}).catch(b=>{console.error(b),chrome.downloads.download({url:T,filename:"TranscripTonic/Transcript.txt",conflictAction:"uniquify"}),console.log("Invalid file name. Transcript downloaded to TranscripTonic directory with simple file name."),t("Transcript downloaded successfully with default file name"),fetch(`https://script.google.com/macros/s/AKfycbw4wRFjJcIoC5uDfscITSjNtUj83JVrBXKn44u9Cs0BoKNgyvt0A5hmG-xsJnlhfVu--g/exec?version=${chrome.runtime.getManifest().version}&code=009&error=${encodeURIComponent(b)}`,{mode:"no-cors"}),fetch(`https://script.google.com/macros/s/AKfycbzUk-q3N8_BWjwE90g9HXs5im1pYFriydKi1m9FoxEmMrWhK8afrHSmYnwYcw6AkH14eg/exec?version=${chrome.runtime.getManifest().version}&isWebhookEnabled=${e}`,{mode:"no-cors"})})}else n(new Error("Failed to read blob"))}}else n(new Error("Meeting at specified index not found"))})})}function S(o){return new Promise((e,t)=>{chrome.storage.local.get(["meetings"],function(n){const a=n;chrome.storage.sync.get(["webhookUrl","webhookBodyType"],function(i){const r=i;if(r.webhookUrl)if(a.meetings||a.meetings[o]){const s=a.meetings[o];let c;r.webhookBodyType==="advanced"?c={meetingTitle:s.meetingTitle||s.title||"",meetingStartTimestamp:new Date(s.meetingStartTimestamp).toISOString(),meetingEndTimestamp:new Date(s.meetingEndTimestamp).toISOString(),transcript:s.transcript,chatMessages:s.chatMessages}:c={meetingTitle:s.meetingTitle||s.title||"",meetingStartTimestamp:new Date(s.meetingStartTimestamp).toLocaleString("default",g).toUpperCase(),meetingEndTimestamp:new Date(s.meetingEndTimestamp).toLocaleString("default",g).toUpperCase(),transcript:M(s.transcript),chatMessages:k(s.chatMessages)},fetch(r.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}).then(l=>{if(!l.ok)throw new Error(`Webhook request failed: ${l.status} ${l.statusText}`)}).then(()=>{a.meetings[o].webhookPostStatus="successful",chrome.storage.local.set({meetings:a.meetings},function(){e("Webhook posted successfully")})}).catch(l=>{console.error(l),a.meetings[o].webhookPostStatus="failed",chrome.storage.local.set({meetings:a.meetings},function(){chrome.notifications.create({type:"basic",iconUrl:"icon.png",title:"Could not post webhook!",message:"Click to view status and retry. Check console for more details."},function(d){chrome.notifications.onClicked.addListener(function(u){u===d&&chrome.tabs.create({url:"meetings.html"})})}),t(l)})})}else t(new Error("Meeting at specified index not found"));else t(new Error("No webhook URL configured"))})})})}function M(o){let e="";return o.length>0&&o.forEach(t=>{e+=`${t.personName} (${new Date(t.timestamp).toLocaleString("default",g).toUpperCase()})
`,e+=t.transcriptText,e+=`

`}),e}function k(o){let e="";return o.length>0&&o.forEach(t=>{e+=`${t.personName} (${new Date(t.timestamp).toLocaleString("default",g).toUpperCase()})
`,e+=t.chatMessageText,e+=`

`}),e}function L(){chrome.storage.local.set({meetingTabId:null},function(){console.log("Meeting tab id cleared for next meeting"),chrome.storage.local.get(["isDeferredUpdatedAvailable"],function(o){o.isDeferredUpdatedAvailable&&(console.log("Applying deferred update"),chrome.storage.local.set({isDeferredUpdatedAvailable:!1},function(){chrome.runtime.reload()}))})})}function x(){return new Promise((o,e)=>{chrome.storage.local.get(["meetings","meetingStartTimestamp"],function(t){const n=t;if(n.meetingStartTimestamp){const a=n.meetings[n.meetings.length-1];!a||n.meetingStartTimestamp!==a.meetingStartTimestamp?p().then(()=>{o("Recovered last meeting to the best possible extent")}).catch(i=>{e(i)}):o("No recovery needed")}else e("No meetings found. May be attend one?")})})}chrome.tabs.onRemoved.addListener(o=>{chrome.storage.local.get(["meetingTabId"],e=>{o===e.meetingTabId&&(console.log("Successfully intercepted tab close"),p().finally(()=>{L()}))})});chrome.runtime.onUpdateAvailable.addListener(()=>{chrome.storage.local.get(["meetingTabId"],o=>{o.meetingTabId?chrome.storage.local.set({isDeferredUpdatedAvailable:!0},()=>{console.log("Deferred update flag set")}):(console.log("No active meeting, applying update immediately"),chrome.runtime.reload())})});class A{canHandle(e){return e.type==="new_meeting_started"}handle(e){chrome.tabs.query({active:!0,currentWindow:!0},t=>{var a;const n=(a=t[0])==null?void 0:a.id;n!==void 0&&chrome.storage.local.set({meetingTabId:n},()=>{console.log("Meeting tab id saved")})})}}class E{canHandle(e){return e.type==="meeting_ended"}async handle(){await p(),L()}}class C{canHandle(e){return e.type==="download_transcript_at_index"}async handle(e,t){if(typeof e.index=="number"&&e.index>=0)try{await y(e.index,!1),t({success:!0})}catch(n){t({success:!1,message:n.message})}else t({success:!1,message:"Invalid index"})}}class I{canHandle(e){return e.type==="retry_webhook_at_index"}async handle(e,t){if(typeof e.index=="number"&&e.index>=0)try{await S(e.index),t({success:!0})}catch(n){console.error("Webhook retry failed:",n),t({success:!1,message:n.message})}else t({success:!1,message:"Invalid index"})}}class D{canHandle(e){return e.type==="recover_last_meeting"}async handle(e,t){try{const n=await x();t({success:!0,message:n})}catch(n){t({success:!1,message:n.message})}}}const N=[new A,new E,new C,new I,new D];chrome.runtime.onMessage.addListener((o,e,t)=>{const n=o;for(const a of N)if(a.canHandle(n))return a.handle(n,t),!0;return console.warn(`No handler found for message type: ${n.type}`),!1});

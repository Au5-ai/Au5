const f={status:400,message:'<strong>TranscripTonic encountered a new error</strong> <br /> Please report it <a href="https://github.com/vivek-nexus/transcriptonic/issues" target="_blank">here</a>.'},q="There is a bug in TranscripTonic. Please report it at https://github.com/vivek-nexus/transcriptonic/issues",A={childList:!0,attributes:!0,subtree:!0,characterData:!0};let E="You",_=[],g="",a="",M="",C=[],k=new Date().toISOString(),L=document.title,T=!1,x=!1,O=!1,b=!1,h,d=!0;Promise.race([z(),new Promise((e,n)=>setTimeout(()=>n(new Error("Recovery timed out")),2e3))]).catch(e=>{e!=="Empty transcript and empty chatMessages"&&console.error(e)}).finally(()=>{y(["meetingStartTimestamp","meetingTitle","transcript","chatMessages"],!1)});Q().then(()=>{chrome.storage.local.get(["extensionStatusJSON"],function(e){h=e.extensionStatusJSON,console.log("Extension status "+h.status),h.status===200?(w(".awLEm").then(()=>{const t=setInterval(()=>{var o;if(O)clearInterval(t);else{const i=(o=document.querySelector(".awLEm"))==null?void 0:o.textContent;i&&(E=i,clearInterval(t))}},100)}),D(2)):u(h)})});function D(e){const n={selector:"",text:""},t={selector:"",text:""};switch(e){case 1:n.selector=".google-material-icons",n.text="call_end",t.selector=".material-icons-extended",t.text="closed_caption_off";break;case 2:n.selector=".google-symbols",n.text="call_end",t.selector=".google-symbols",t.text="closed_caption_off"}w(n.selector,n.text).then(()=>{console.log("Meeting started");const o={type:"new_meeting_started"};chrome.runtime.sendMessage(o,function(){}),O=!0,setTimeout(()=>$(),5e3);let i,c;try{const s=v(t.selector,t.text)[0];chrome.storage.sync.get(["operationMode"],function(m){m.operationMode==="manual"?console.log("Manual mode selected, leaving transcript off"):s.click()});let r=document.querySelector('div[role="region"][tabindex="0"]');if(r||(r=document.querySelector(".a4cQT"),d=!1),r)d?r.setAttribute("style","opacity:0.2"):r.children[1].setAttribute("style","opacity:0.2"),i=new MutationObserver(I),i.observe(r,A);else throw new Error("Transcript element not found in DOM")}catch(s){console.error(s),T=!0,u(f),p("001",s)}try{const s=v(".google-symbols","chat")[0];s.click(),w('div[aria-live="polite"].Ge9Kpc').then(()=>{s.click();try{const r=document.querySelector('div[aria-live="polite"].Ge9Kpc');if(r)c=new MutationObserver(j),c.observe(r,A);else throw new Error("Chat messages element not found in DOM")}catch(r){console.error(r),x=!0,u(f),p("002",r)}})}catch(s){console.error(s),x=!0,u(f),p("003",s)}!T&&!x&&chrome.storage.sync.get(["operationMode"],function(s){s.operationMode==="manual"?u({status:400,message:"<strong>TranscripTonic is not running</strong> <br /> Turn on captions using the CC icon, if needed"}):u(h)});try{v(n.selector,n.text)[0].parentElement.parentElement.addEventListener("click",()=>{b=!0,i&&i.disconnect(),c&&c.disconnect(),g!==""&&a!==""&&S(),y(["transcript","chatMessages"],!0)})}catch(s){console.error(s),u(f),p("004",s)}})}function I(e){e.forEach(()=>{var n,t,o,i,c;try{const s=d?(n=document.querySelector('div[role="region"][tabindex="0"]'))==null?void 0:n.children:(i=(o=(t=document.querySelector(".a4cQT"))==null?void 0:t.childNodes[1])==null?void 0:o.firstChild)==null?void 0:i.childNodes;if(s)if(d?s.length>1:s.length>0){const r=d?s[s.length-2]:s[s.length-1],m=r.childNodes[0].textContent,l=(c=r.childNodes[1].lastChild)==null?void 0:c.textContent;m&&l&&(a===""?(g=m,M=new Date().toISOString(),a=l):g!==m?(S(),g=m,M=new Date().toISOString(),a=l):(d&&l.length-a.length<-250&&S(),a=l,d||l.length>250&&r.remove()))}else console.log("No active transcript"),g!==""&&a!==""&&S(),g="",a="";a.length>125?console.log(a.slice(0,50)+" ... "+a.slice(-50)):console.log(a)}catch(s){console.error(s),!T&&!b&&(console.log(q),u(f),p("005",s)),T=!0}})}function j(e){e.forEach(()=>{var n,t,o,i;try{const c=document.querySelector('div[aria-live="polite"].Ge9Kpc');if(c&&c.children.length>0){const s=c.lastChild,r=(t=(n=s==null?void 0:s.firstChild)==null?void 0:n.firstChild)==null?void 0:t.textContent,m=new Date().toISOString(),l=(i=(o=s==null?void 0:s.lastChild)==null?void 0:o.lastChild)==null?void 0:i.textContent;r&&l&&B({personName:r==="You"?E:r,timestamp:m,chatMessageText:l})}}catch(c){console.error(c),!x&&!b&&(console.log(q),u(f),p("006",c)),x=!0}})}function S(){_.push({personName:g==="You"?E:g,timestamp:M,transcriptText:a}),y(["transcript"],!1)}function B(e){C.some(t=>t.personName===e.personName&&e.chatMessageText.includes(t.chatMessageText))||(console.log(e),C.push(e),y(["chatMessages"],!1))}function y(e,n){const t={};e.includes("transcript")&&(t.transcript=_),e.includes("meetingTitle")&&(t.meetingTitle=L),e.includes("meetingStartTimestamp")&&(t.meetingStartTimestamp=k),e.includes("chatMessages")&&(t.chatMessages=C),chrome.storage.local.set(t,function(){if(P(),n){const o={type:"meeting_ended"};chrome.runtime.sendMessage(o,function(){})}})}function P(){const e=`position: fixed;
    top: 0px;
    width: 100%;
    height: 4px;
    z-index: 100;
    transition: background-color 0.3s ease-in
  `;let n=document.querySelector("#transcriptonic-status");if(n)n.style.cssText=`background-color: #2A9ACA; ${e}`;else{let t=document.querySelector("html");n=document.createElement("div"),n.setAttribute("id","transcriptonic-status"),n.style.cssText=`background-color: #2A9ACA; ${e}`,t==null||t.appendChild(n)}setTimeout(()=>{n.style.cssText=`background-color: transparent; ${e}`},3e3)}function $(){try{const e=document.querySelector(".u6vdEc");if(e!=null&&e.textContent)L=e.textContent,y(["meetingTitle"],!1);else throw new Error("Meeting title element not found in DOM")}catch(e){console.error(e),b||p("007",e)}}function v(e,n){var t=document.querySelectorAll(e);return Array.prototype.filter.call(t,function(o){return RegExp(n).test(o.textContent)})}async function w(e,n){if(n)for(;!Array.from(document.querySelectorAll(e)).find(t=>t.textContent===n);)await new Promise(t=>requestAnimationFrame(t));else for(;!document.querySelector(e);)await new Promise(t=>requestAnimationFrame(t));return document.querySelector(e)}function u(e){let n=document.querySelector("html"),t=document.createElement("div"),o=document.createElement("img"),i=document.createElement("p");o.setAttribute("src","https://ejnana.github.io/transcripto-status/icon.png"),o.setAttribute("height","32px"),o.setAttribute("width","32px"),o.style.cssText="border-radius: 4px",setTimeout(()=>{t.style.display="none"},5e3),e.status===200?(t.style.cssText=`color: #2A9ACA; ${N}`,i.innerHTML=e.message):(t.style.cssText=`color: orange; ${N}`,i.innerHTML=e.message),t.prepend(i),t.prepend(o),n&&n.append(t)}const N=`background: rgb(255 255 255 / 10%); 
    backdrop-filter: blur(16px); 
    position: fixed;
    top: 5%; 
    left: 0; 
    right: 0; 
    margin-left: auto; 
    margin-right: auto;
    max-width: 780px;  
    z-index: 1000; 
    padding: 0rem 1rem;
    border-radius: 8px; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    gap: 16px;  
    font-size: 1rem; 
    line-height: 1.5; 
    font-family: "Google Sans",Roboto,Arial,sans-serif; 
    box-shadow: rgba(0, 0, 0, 0.16) 0px 10px 36px 0px, rgba(0, 0, 0, 0.06) 0px 0px 0px 1px;`;function p(e,n){fetch(`https://script.google.com/macros/s/AKfycbxiyQSDmJuC2onXL7pKjXgELK1vA3aLGZL5_BLjzCp7fMoQ8opTzJBNfEHQX_QIzZ-j4Q/exec?version=${chrome.runtime.getManifest().version}&code=${e}&error=${encodeURIComponent(n)}`,{mode:"no-cors"})}async function Q(){chrome.storage.local.set({extensionStatusJSON:{status:200,message:"<strong>TranscripTonic is running</strong> <br /> Do not turn off captions"}}),await fetch("https://ejnana.github.io/transcripto-status/status-prod.json",{cache:"no-store"}).then(e=>e.json()).then(e=>{chrome.storage.local.set({extensionStatusJSON:e},function(){console.log("Extension status fetched and saved")})}).catch(e=>{console.error(e),p("008",e)})}function z(){return new Promise((e,n)=>{const t={type:"recover_last_meeting"};chrome.runtime.sendMessage(t,function(o){const i=o;i.success?e("Last meeting recovered successfully or recovery not needed"):n(i.message)})})}

class I{reload(){chrome.runtime.reload()}sendMessage(e,r=()=>{}){chrome.runtime.sendMessage(e,r)}}class b{async remove(e){return new Promise((r,n)=>{chrome.storage.local.remove(e,()=>{if(chrome.runtime.lastError)return n(chrome.runtime.lastError);r()})})}async set(e,r){return new Promise((n,i)=>{chrome.storage.local.set({[e]:r},()=>{if(chrome.runtime.lastError)return i(chrome.runtime.lastError);n(r)})})}async get(e){const r=Array.isArray(e)?e:[e];return new Promise((n,i)=>{chrome.storage.local.get(r,g=>{if(chrome.runtime.lastError)return i(chrome.runtime.lastError);n(g)})})}async getSync(e){return new Promise((r,n)=>{chrome.storage.sync.get([e],i=>{if(chrome.runtime.lastError)return n(chrome.runtime.lastError);r(i)})})}}async function x(t,...e){let r=t;for(const n of e)r=await n(r);return r}const S="configuration";class D{constructor(e){this.storageService=e}async getConfig(){try{return N}catch(e){throw console.error("Failed to load configuration:",e),new Error("Configuration not found.")}}async setConfig(e){try{await this.storageService.set(S,e)}catch(r){console.error("Failed to save configuration:",r)}}async getValue(e){const r=await this.getConfig();return r?r[e]:null}async setValue(e,r){const n=await this.getConfig()||{};n[e]=r,await this.setConfig(n)}async clearConfig(){try{await this.storageService.remove(S)}catch(e){console.error("Failed to clear configuration:",e)}}}const k={meetingEndIcon:{selector:".google-symbols",text:"call_end"},captionsIcon:{selector:".google-symbols",text:"closed_caption_off"},transcriptSelectors:{ariaBased:'div[role="region"][tabindex="0"]',fallback:".a4cQT"},transcriptStyles:{opacity:"0.2"},maxTranscriptLength:250,transcriptTrimThreshold:125,canUseAriaBasedTranscriptSelector:!0},N={Service:{webhookUrl:"https://au5.ai/api/v1/",token:"",userId:"23f45e89-8b5a-5c55-9df7-240d78a3ce15",fullName:"Mohammad Karimi"},Extension:k};var C=(t=>(t.MEETING_STARTED="meetingStarted",t.MEETING_ENDED="meetingEnded",t))(C||{});async function U(t,e){const r=n=>{var i;return e?((i=n.textContent)==null?void 0:i.trim())===e:!0};for(;;){const i=Array.from(document.querySelectorAll(t)).find(r);if(i instanceof HTMLElement)return i;await new Promise(requestAnimationFrame)}}function A(t){return document.querySelector(t)}function v(t,e){const r=document.querySelectorAll(t);if(!e)return Array.from(r);const n=new RegExp(e);return Array.from(r).filter(i=>n.test(i.textContent||""))}function F(t,e,r){if(e)t.style.opacity=r;else{const n=t.children[1];n==null||n.setAttribute("style",`opacity: ${r};`)}}function _(t,e){let r=document.querySelector(t);const n=!!r;return r||(r=document.querySelector(e)),{container:r,useAria:n}}function L(){const e=new URL(window.location.href).pathname.split("/").filter(Boolean);return e.length>0?e[e.length-1]:"N/A"}let s;const O=new I,R=new D(new b);let M=!1,B=[],a="",o="",l="",T=!1,m;const q=async t=>(s=await R.getConfig(),t.meetingTitle=L(),t),P=async t=>{var r;const e=s.Extension.captionsIcon;return t.captionsButton=v(e.selector,e.text)[0],(r=t.captionsButton)==null||r.click(),t},G=async t=>{const e=_(s.Extension.transcriptSelectors.aria,s.Extension.transcriptSelectors.fallback);if(!e)throw new Error("Transcript container not found in DOM");return t.transcriptContainer=e.container,t.canUseAriaBasedTranscriptSelector=e.useAria,t},$=async t=>(t.transcriptContainer&&F(t.transcriptContainer,t.canUseAriaBasedTranscriptSelector,s.Extension.transcriptStyles.opacity),t),H=async t=>(t.transcriptContainer&&(m=new MutationObserver(Y(t)),m.observe(t.transcriptContainer,{childList:!0,attributes:!0,subtree:!0,characterData:!0})),t),K=async t=>(J(),t);async function V(t){try{await U(s.Extension.meetingEndIcon.selector,s.Extension.meetingEndIcon.text),t.sendMessage({type:C.MEETING_STARTED})}catch(e){console.error("Failed to detect meeting start:",e)}}V(O).then(async()=>x({hasMeetingStarted:!0},q,P,G,$,H,K)).catch(t=>{console.error("Meeting routine execution failed:",t),T=!0});function Y(t){return function(e,r){z(e,t)}}function z(t,e){var r,n,i,g,w;for(const Q of t)try{const c=e.canUseAriaBasedTranscriptSelector?A(s.Extension.transcriptSelectors.aria):A(s.Extension.transcriptSelectors.fallback),u=e.canUseAriaBasedTranscriptSelector?c==null?void 0:c.children:(n=(r=c==null?void 0:c.childNodes[1])==null?void 0:r.firstChild)==null?void 0:n.childNodes;if(!u)return;if(!(e.canUseAriaBasedTranscriptSelector?u.length>1:u.length>0)){a&&o&&h(a,o,l),a="",o="";continue}const p=e.canUseAriaBasedTranscriptSelector?u[u.length-2]:u[u.length-1],E=p.childNodes[0],y=(i=p.childNodes[1])==null?void 0:i.lastChild,d=((g=E==null?void 0:E.textContent)==null?void 0:g.trim())??"",f=((w=y==null?void 0:y.textContent)==null?void 0:w.trim())??"";if(!d||!f)continue;o===""?(a=d,l=new Date().toISOString(),o=f):a!==d?(h(a,o,l),a=d,l=new Date().toISOString(),o=f):(e.canUseAriaBasedTranscriptSelector&&f.length-o.length<-s.Extension.maxTranscriptLength&&h(a,o,l),o=f,!e.canUseAriaBasedTranscriptSelector&&f.length>s.Extension.maxTranscriptLength&&p.remove()),console.log(o.length>s.Extension.transcriptTrimThreshold?`${o.slice(0,50)} ... ${o.slice(-50)}`:o)}catch(c){console.error(c),!T&&!M&&console.log("Error in transcript mutation observer:",c),T=!0}}function h(t,e,r){if(!o||!l)return;const n=t==="You"?s.Service.fullName:t;B.push({speaker:n,timestamp:l,transcript:e})}function J(){var t,e;try{const r=v(s.Extension.meetingEndIcon.selector,s.Extension.meetingEndIcon.text),n=((e=(t=r==null?void 0:r[0])==null?void 0:t.parentElement)==null?void 0:e.parentElement)??null;if(!n)throw new Error("Meeting end button not found in DOM.");n.addEventListener("click",()=>{M=!0,m==null||m.disconnect(),a&&o&&h(a,o,l),console.log("Meeting ended. Transcript data:",JSON.stringify(B))})}catch(r){console.error("Error setting up meeting end listener:",r)}}

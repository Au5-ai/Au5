var P=Object.defineProperty;var k=(t,e,n)=>e in t?P(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var x=(t,e,n)=>k(t,typeof e!="symbol"?e+"":e,n);class B{reload(){chrome.runtime.reload()}sendMessage(e,n=()=>{}){chrome.runtime.sendMessage(e,n)}}class N{async remove(e){return new Promise((n,r)=>{chrome.storage.local.remove(e,()=>{if(chrome.runtime.lastError)return r(chrome.runtime.lastError);n()})})}async set(e,n){return new Promise((r,o)=>{chrome.storage.local.set({[e]:n},()=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);r(n)})})}async get(e){const n=Array.isArray(e)?e:[e];return new Promise((r,o)=>{chrome.storage.local.get(n,m=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);r(m)})})}async getSync(e){return new Promise((n,r)=>{chrome.storage.sync.get([e],o=>{if(chrome.runtime.lastError)return r(chrome.runtime.lastError);n(o)})})}}async function D(t,...e){let n=t;for(const r of e)n=await r(n);return n}const w="configuration";class U{constructor(e){this.storageService=e}async getConfig(){try{return O}catch(e){throw console.error("Failed to load configuration:",e),new Error("Configuration not found.")}}async setConfig(e){try{await this.storageService.set(w,e)}catch(n){console.error("Failed to save configuration:",n)}}async getValue(e){const n=await this.getConfig();return n?n[e]:null}async setValue(e,n){const r=await this.getConfig()||{};r[e]=n,await this.setConfig(r)}async clearConfig(){try{await this.storageService.remove(w)}catch(e){console.error("Failed to clear configuration:",e)}}}const F={meetingEndIcon:{selector:".google-symbols",text:"call_end"},captionsIcon:{selector:".google-symbols",text:"closed_caption_off"},transcriptSelectors:{aria:'div[role="region"][tabindex="0"]',fallback:".a4cQT"},transcriptStyles:{opacity:"0.2"},maxTranscriptLength:250,transcriptTrimThreshold:125},O={Service:{webhookUrl:"https://au5.ai/api/v1/",token:"",userId:"23f45e89-8b5a-5c55-9df7-240d78a3ce15",fullName:"Mohammad Karimi"},Extension:F};var C=(t=>(t.MEETING_STARTED="meetingStarted",t.MEETING_ENDED="meetingEnded",t))(C||{});class v{static create(){if(this.chatPanel){console.warn("ChatPanel already exists.");return}this.chatPanel=document.createElement("div"),this.chatPanel.id="au5-chat-panel",Object.assign(this.chatPanel.style,{border:"1px solid transparent",alignItems:"center",backgroundColor:"var(--hotlane-background-color)",borderRadius:"16px",bottom:"80px",boxSizing:"border-box",display:"flex",justifyContent:"center",maxWidth:"100%",overflow:"hidden",position:"absolute",right:"16px",top:"16px",transform:"none",zIndex:"9999",transition:"transform .5s cubic-bezier(.4,0,.2,1), bottom .5s cubic-bezier(0.4,0,0.2,1)",width:"360px"}),document.body.appendChild(this.chatPanel),[{className:"fJsklc ZmuLbd Didmac G03iKb",styles:{top:"0px",right:"376px",left:"0px"}},{className:"axUSnc cZXVke  P9KVBf",styles:{inset:"72px 392px 80px 16px"}}].forEach(({className:r,styles:o})=>{const m=document.getElementsByClassName(r);Array.from(m).forEach(h=>{Object.assign(h.style,o)})});const n=document.getElementsByClassName("dkjMxf i8wGAe iPFm3e")[0];n&&(n.style.width=parseInt(n.style.width,10)-376+"px")}static destroy(){this.chatPanel?(document.body.removeChild(this.chatPanel),this.chatPanel=null):console.warn("ChatPanel does not exist.")}}x(v,"chatPanel",null);async function R(t,e){const n=r=>{var o;return e?((o=r.textContent)==null?void 0:o.trim())===e:!0};for(;;){const o=Array.from(document.querySelectorAll(t)).find(n);if(o instanceof HTMLElement)return o;await new Promise(requestAnimationFrame)}}function b(t){return document.querySelector(t)}function A(t,e){const n=Array.from(document.querySelectorAll(t));if(!e)return n;const r=new RegExp(e);return n.filter(o=>r.test(o.textContent??""))}function L(t,e,n){if(e)t.style.opacity=n;else{const r=t.children[1];r==null||r.setAttribute("style",`opacity: ${n};`)}}function _(t,e){let n=document.querySelector(t);const r=!!n;return n||(n=document.querySelector(e)),{container:n,useAria:r}}function q(){const e=new URL(window.location.href).pathname.split("/").filter(Boolean);return e.length>0?e[e.length-1]:"N/A"}let i;const G=new B,z=new U(new N);let I=!1,M=[],a="",s="",l="",T=!1,f;const j=async t=>{var n;const e=i.Extension.captionsIcon;return t.captionsButton=A(e.selector,e.text)[0],(n=t.captionsButton)==null||n.click(),t},K=async t=>{const e=_(i.Extension.transcriptSelectors.aria,i.Extension.transcriptSelectors.fallback);if(!e)throw new Error("Transcript container not found in DOM");return t.transcriptContainer=e.container,t.canUseAriaBasedTranscriptSelector=e.useAria,t},V=async t=>(t.transcriptContainer&&L(t.transcriptContainer,t.canUseAriaBasedTranscriptSelector,i.Extension.transcriptStyles.opacity),t),$=async t=>(t.transcriptContainer&&(f=new MutationObserver(Z(t)),f.observe(t.transcriptContainer,{childList:!0,attributes:!0,subtree:!0,characterData:!0})),t),H=async t=>(await new Promise(e=>setTimeout(e,5e3)),v.create(),t),J=async t=>(W(),t);async function Y(t){try{i=await z.getConfig();const e=q();await R(i.Extension.meetingEndIcon.selector,i.Extension.meetingEndIcon.text),t.sendMessage({type:C.MEETING_STARTED,value:{meetingTitle:e}})}catch(e){console.error("Failed to detect meeting start:",e)}}Y(G).then(async()=>D({hasMeetingStarted:!0},j,K,V,$,H,J)).catch(t=>{console.error("Meeting routine execution failed:",t),T=!0});function Z(t){return function(e,n){Q(e,t)}}function Q(t,e){var n,r,o,m,h;for(const X of t)try{const c=e.canUseAriaBasedTranscriptSelector?b(i.Extension.transcriptSelectors.aria):b(i.Extension.transcriptSelectors.fallback),u=e.canUseAriaBasedTranscriptSelector?c==null?void 0:c.children:(r=(n=c==null?void 0:c.childNodes[1])==null?void 0:n.firstChild)==null?void 0:r.childNodes;if(!u)return;if(!(e.canUseAriaBasedTranscriptSelector?u.length>1:u.length>0)){a&&s&&p(a,s,l),a="",s="";continue}const y=e.canUseAriaBasedTranscriptSelector?u[u.length-2]:u[u.length-1],E=y.childNodes[0],S=(o=y.childNodes[1])==null?void 0:o.lastChild,g=((m=E==null?void 0:E.textContent)==null?void 0:m.trim())??"",d=((h=S==null?void 0:S.textContent)==null?void 0:h.trim())??"";if(!g||!d)continue;s===""?(a=g,l=new Date().toISOString(),s=d):a!==g?(p(a,s,l),a=g,l=new Date().toISOString(),s=d):(e.canUseAriaBasedTranscriptSelector&&d.length-s.length<-i.Extension.maxTranscriptLength&&p(a,s,l),s=d,!e.canUseAriaBasedTranscriptSelector&&d.length>i.Extension.maxTranscriptLength&&y.remove()),console.log(s.length>i.Extension.transcriptTrimThreshold?`${s.slice(0,50)} ... ${s.slice(-50)}`:s)}catch(c){console.error(c),!T&&!I&&console.log("Error in transcript mutation observer:",c),T=!0}}function p(t,e,n){if(!s||!l)return;const r=t==="You"?i.Service.fullName:t;M.push({speaker:r,timestamp:l,transcript:e})}function W(){var t,e;try{const n=A(i.Extension.meetingEndIcon.selector,i.Extension.meetingEndIcon.text),r=((e=(t=n==null?void 0:n[0])==null?void 0:t.parentElement)==null?void 0:e.parentElement)??null;if(!r)throw new Error("Meeting end button not found in DOM.");r.addEventListener("click",()=>{I=!0,f==null||f.disconnect(),a&&s&&p(a,s,l),console.log("Meeting ended. Transcript data:",JSON.stringify(M))})}catch(n){console.error("Error setting up meeting end listener:",n)}}

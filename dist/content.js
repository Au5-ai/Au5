class I{reload(){chrome.runtime.reload()}sendMessage(e,r=()=>{}){chrome.runtime.sendMessage(e,r)}}class b{async remove(e){return new Promise((r,n)=>{chrome.storage.local.remove(e,()=>{if(chrome.runtime.lastError)return n(chrome.runtime.lastError);r()})})}async set(e,r){return new Promise((n,o)=>{chrome.storage.local.set({[e]:r},()=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);n(r)})})}async get(e){const r=Array.isArray(e)?e:[e];return new Promise((n,o)=>{chrome.storage.local.get(r,f=>{if(chrome.runtime.lastError)return o(chrome.runtime.lastError);n(f)})})}async getSync(e){return new Promise((r,n)=>{chrome.storage.sync.get([e],o=>{if(chrome.runtime.lastError)return n(chrome.runtime.lastError);r(o)})})}}const w="configuration";class A{constructor(e){this.storageService=e}async getConfig(){try{return D}catch(e){throw console.error("Failed to load configuration:",e),new Error("Configuration not found.")}}async setConfig(e){try{await this.storageService.set(w,e)}catch(r){console.error("Failed to save configuration:",r)}}async getValue(e){const r=await this.getConfig();return r?r[e]:null}async setValue(e,r){const n=await this.getConfig()||{};n[e]=r,await this.setConfig(n)}async clearConfig(){try{await this.storageService.remove(w)}catch(e){console.error("Failed to clear configuration:",e)}}}const N={meetingEndIcon:{selector:".google-symbols",text:"call_end"},captionsIcon:{selector:".google-symbols",text:"closed_caption_off"},transcriptSelectors:{ariaBased:'div[role="region"][tabindex="0"]',fallback:".a4cQT"},transcriptStyles:{opacity:"0.2"},maxTranscriptLength:250,transcriptTrimThreshold:125},D={Service:{webhookUrl:"https://au5.ai/api/v1/",token:"",userId:"23f45e89-8b5a-5c55-9df7-240d78a3ce15",fullName:"Mohammad Karimi"},Extension:N};var T=(t=>(t.MEETING_STARTED="meetingStarted",t.MEETING_ENDED="meetingEnded",t))(T||{});async function k(t,e){const r=n=>{var o;return e?((o=n.textContent)==null?void 0:o.trim())===e:!0};for(;;){const o=Array.from(document.querySelectorAll(t)).find(r);if(o instanceof HTMLElement)return o;await new Promise(requestAnimationFrame)}}function v(t,e){const r=document.querySelectorAll(t);if(!e)return Array.from(r);const n=new RegExp(e);return Array.from(r).filter(o=>n.test(o.textContent||""))}class B{static async log(e){try{const r={...e,timestamp:new Date().toISOString(),extensionVersion:"1.0.0",userId:"23f45e89-8b5a-5c55-9df7-240d78a3ce15"};console.log(r)}catch(r){console.warn("[RemoteLogger] Failed to send log",r)}}static info(e,r){this.log({level:"info",message:e,context:r})}static warn(e,r){this.log({level:"warn",message:e,context:r})}static error(e,r){this.log({level:"error",message:e,context:r})}}let s,C=!1,M=[];async function F(t){try{await k(meetingEndIcon.selector,meetingEndIcon.text),t.sendMessage({type:T.MEETING_STARTED}),hasMeetingStarted=!0}catch(e){console.error("Failed to detect meeting start:",e)}}const L={childList:!0,attributes:!0,subtree:!0,characterData:!0};let a=!0,x=!1,m;F(new I).then(async()=>{s=await new A(new b).getConfig(),B.info(P()??"No meeting title found","meetingRoutines");try{const t=v(s.Extension.captionsIcon.selector,s.Extension.captionsIcon.text)[0];t==null||t.click();const e=O();if(!e)throw new Error("Transcript container not found in DOM");_(e),q(e),R()}catch(t){console.error("Transcript initialization error:",t),x=!0}}).catch(t=>{console.error("Meeting routine execution failed:",t)});function R(){try{const t=G(s.Extension.meetingEndIcon);if(!t)throw new Error("Meeting end button not found in DOM.");t.addEventListener("click",$)}catch(t){console.error("Error setting up meeting end listener:",t)}}function O(){let t=document.querySelector(s.Extension.transcriptSelectors.ariaBased);return a=!!t,t||(t=document.querySelector(s.Extension.transcriptSelectors.fallback)),t}function _(t){if(a)t.style.opacity=s.Extension.transcriptStyles.opacity;else{const e=t.children[1];e==null||e.setAttribute("style",`opacity: ${s.Extension.transcriptStyles.opacity};`)}}function q(t){m=new MutationObserver(U),m.observe(t,L)}function P(){const e=new URL(window.location.href).pathname.split("/").filter(Boolean);return e.length>0?e[e.length-1]:null}let l="",i="",p="";function U(t){var e,r,n,o,f;for(const V of t)try{const c=a?document.querySelector(s.Extension.transcriptSelectors.ariaBased):document.querySelector(s.Extension.transcriptSelectors.fallback),u=a?c==null?void 0:c.children:(r=(e=c==null?void 0:c.childNodes[1])==null?void 0:e.firstChild)==null?void 0:r.childNodes;if(!u)return;if(!(a?u.length>1:u.length>0)){console.log("No active transcript"),l&&i&&h(),l="",i="";continue}const E=a?u[u.length-2]:u[u.length-1],y=E.childNodes[0],S=(n=E.childNodes[1])==null?void 0:n.lastChild,d=((o=y==null?void 0:y.textContent)==null?void 0:o.trim())??"",g=((f=S==null?void 0:S.textContent)==null?void 0:f.trim())??"";if(!d||!g)continue;i===""?(l=d,p=new Date().toISOString(),i=g):l!==d?(h(),l=d,p=new Date().toISOString(),i=g):(a&&g.length-i.length<-s.Extension.maxTranscriptLength&&h(),i=g,!a&&g.length>s.Extension.maxTranscriptLength&&(console.log("Transcript text too long, trimming..."),E.remove())),console.log(i.length>s.Extension.transcriptTrimThreshold?`${i.slice(0,50)} ... ${i.slice(-50)}`:i)}catch(c){console.error(c),!x&&!C&&console.log("Error in transcript mutation observer:",c),x=!0}}function h(){if(!i||!p)return;const t=l==="You"?s.Service.fullName:l;M.push({personName:t,timestamp:p,text:i})}function G(t){var r,n;const e=v(t.selector,t.text);return((n=(r=e==null?void 0:e[0])==null?void 0:r.parentElement)==null?void 0:n.parentElement)??null}function $(){C=!0,m==null||m.disconnect(),l&&i&&h(),console.log("Meeting ended. Transcript data:",JSON.stringify(M))}
